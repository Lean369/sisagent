# Readme SAAS Siagent

## Funcionalidades:

- Integraci√≥n con Flask para multi-hilo
- Multi-tenancy
- Conexi√≥n en Pool a Postgres.
- Fallback de LLM
- Compilaci√≥n con interrupci√≥n (HITL).

## Caracteres Unicode
‚ö†Ô∏è  ‚ñ≤  üî∫ 
üü¢ üü° üî¥
üü©
## Detalle de Funcionalidades

### Integraci√≥n con Flask para multi-hilo

La app est√° dise√±ada para integrarse con Flask. Separa la l√≥gica del Pool de Conexiones (que vive todo el tiempo) de la Ejecuci√≥n del Agente (que ocurre en cada petici√≥n web), e incluye una herramienta de ejecuci√≥n.

### Conexi√≥n en Pool a Postgres

La app utiliza el ConnectionPool de Postgres para manejar la concurrencia de llamadas correctamente. LangGraph necesita una conexi√≥n activa para guardar memoria, y el Pool te da conexiones bajo demanda.
La inicializaci√≥n de tablas solo se ejecuta una vez al arrancar usando una conexi√≥n temporal del pool para verificar que las tablas existan.
La configuraci√≥n por defecto es de hasta 20 usuarios simult√°neos procesando

Ventajas de este enfoque
- Escalable: pool = ConnectionPool(...) maneja m√∫ltiples usuarios a la vez sin saturar la base de datos.
- Robusto: Si la conexi√≥n se cae, el pool intenta reconectar autom√°ticamente.

Configuraciones:
- max_lifetime=600: Obliga al pool a tirar a la basura cualquier conexi√≥n que tenga m√°s de 10 minutos de vida. Esto previene errores silenciosos que ocurren cuando una conexi√≥n vive "demasiado" (d√≠as).

- max_idle=300: Si una conexi√≥n no se usa en 5 minutos, se cierra. La pr√≥xima vez que alguien pida una, el pool crear√° una nueva y fresca.

- keepalives: Le dice al sistema operativo que env√≠e peque√±os "pings" a la base de datos cada 30 segundos. Esto evita que los firewalls corten la conexi√≥n creyendo que est√° abandonada.

### Multi-tenancy

Para manejar m√∫ltiples negocios (Multi-tenancy) en una sola aplicaci√≥n de Agentes, Se basa en tres pilares fundamentales: Identificaci√≥n Compuesta, Configuraci√≥n Din√°mica y Aislamiento de Contexto.

Es como si la aplicaci√≥n funcionara como un Hotel:

La App es el edificio.
- El Business ID es el n√∫mero de piso (cada empresa tiene su estilo).
- El User ID es el n√∫mero de habitaci√≥n (cada cliente tiene su historia).
- El Thread ID es la llave √∫nica que combina ambos (piso_habitacion).

La Estrategia de IDs (La Clave) para no mezclar por ejemplo el "cliente_1" de la Pizzer√≠a con el "cliente_2" de la Zapater√≠a.

thread_id = f"{business_id}:{user_id}"

### Fallback de LLM

Las APIs fallan, tienen l√≠mites de velocidad (Rate Limits) o entran en mantenimiento. El agente tiene la capacidad de cambiar el LLM autom√°ticamente.

En el ecosistema LangChain/LangGraph, existe una funci√≥n nativa y elegante llamada .with_fallbacks().

Estrategia: "El Doble Motor"
El truco es configurar ambos modelos por separado, vincular las herramientas a ambos, y luego unirlos en un solo objeto ejecutable.

### Human-in-the-Loop (HITL) / "Modo Copiloto"

¬øQu√© es? En lugar de que el agente haga todo autom√°tico siempre, permites que para acciones sensibles (como "Autorizar devoluci√≥n", "Agendar cita confirmada" o "Dar descuento"), el agente se detenga, le avise a un humano (el due√±o del negocio), y espere su aprobaci√≥n (un click) para continuar.

¬øPor qu√© es novedoso y √∫til?

Elimina el miedo: El mayor freno de venta de IA a empresas es: "¬øY si el bot se vuelve loco y regala mi inventario?". Con esto, les garantizas control.

Es nativo de LangGraph: A diferencia de LangChain cl√°sico, LangGraph fue dise√±ado espec√≠ficamente para esto (capacidad de pausar un hilo y reanudarlo). Muy pocos competidores lo implementan porque es t√©cnicamente complejo si no usas grafos.

- Detalle de llamadas de ejemplo con y sin uso de herramientas:

```bash
curl -X POST http://localhost:5000/chat \
  -H "Content-Type: application/json" \
  -d '{"message":"Hola, quienes son?","user_id":"user123","business_id":"nike_store"}'

  {"response":"Soy un experto en calzado deportivo y vendedor de zapatillas Nike. Estoy aqu\u00ed para ayudarte a encontrar el par perfecto de zapatillas Nike que se adapte a tus necesidades y preferencias. \u00bfQu\u00e9 tipo de zapatillas Nike te gustar\u00eda conocer m\u00e1s sobre?","status":"COMPLETADO"}

  curl -X POST http://localhost:5000/chat \
  -H "Content-Type: application/json" \
  -d '{"message":"No, gracias ,  adios!","user_id":"user123","business_id":"nike_store"}'

"{"message":"El asistente solicita permiso para ejecutar: consultar_inventario","status":"REQUIERE_APROBACION","tool_args":{"producto":"zapatillas Nike disponibles"},"tool_name":"consultar_inventario"}"


curl -X POST http://localhost:5000/aprobar \
  -H "Content-Type: application/json" \
  -d '{"thread_id":"nike_store:user123","decision":"approve"}'

curl -X POST http://localhost:5000/aprobar \
  -H "Content-Type: application/json" \
  -d '{"business_id":"cliente2","user_id":"5491131376731@s.whatsapp.net","decision":"approve"}'

{"response":"Tenemos varios modelos de zapatillas Nike disponibles, incluyendo Air Max, Air Force, Jordan, y m\u00e1s. \u00bfTe gustar\u00eda saber m\u00e1s sobre alguno de estos modelos en particular?","status":"ACCION_EJECUTADA"}

curl -X POST http://localhost:5000/chat \
  -H "Content-Type: application/json" \
  -d '{"message":"No, gracias ,  adios!","user_id":"user123","business_id":"nike_store"}'

{"response":"\u00a1Hasta luego! Que tengas un buen d\u00eda y si necesitas algo m\u00e1s, no dudes en regresar. \u00a1Que te vaya bien!","status":"COMPLETADO"}

curl -X POST http://localhost:5000/aprobar \
  -H "Content-Type: application/json" \
  -d '{"business_id":"cliente2","user_id":"5491131376731@s.whatsapp.net","decision":"reject"}'
  ```

## Borrado de memoria BD Postgres

LangGraph guarda datos en 3 tablas principales: checkpoints, checkpoint_blobs y checkpoint_writes. Debemos limpiar las tres para ese usuario.

```bash
curl -X DELETE http://localhost:5000/borrar_memoria \
  -H "Content-Type: application/json" \
  -d '{"user_id":"5491131376731@s.whatsapp.net", "business_id":"cliente2"}'
```

Borrado Total (Reset de F√°brica - Cuidado ‚ö†Ô∏è)
Esto borrar√° el historial de todos los clientes de todos los negocios. Tu bot arrancar√° como si lo hubieras instalado hoy.

SQL
TRUNCATE TABLE checkpoints, checkpoint_blobs, checkpoint_writes;

¬øQu√© pasa despu√©s de borrar?
La pr√≥xima vez que ese usuario env√≠e un mensaje, LangGraph buscar√° su thread_id en la base de datos.
Como no encontrar√° nada, iniciar√° un nuevo estado vac√≠o.
Se ejecutar√° el System Prompt original de nuevo.
El bot no recordar√° nada de lo anterior (ni el nombre, ni pedidos previos).

### Time Out de aprobaciones

Como la aplicaci√≥n es pasiva (solo despierta cuando recibe una petici√≥n HTTP), el concepto de "liberarse sola" funciona as√≠:

Al intentar Aprobar: Si el usuario hace clic en "Aprobar" despu√©s de X minutos, el sistema le dice "La solicitud caduc√≥" y cancela la acci√≥n.

Al volver a Hablar: Si el usuario ignora la aprobaci√≥n y escribe "Hola" 2 horas despu√©s, el sistema detecta que la acci√≥n pendiente es vieja, la cancela autom√°ticamente y procesa el "Hola" como nuevo.

¬øQu√© logra esto?
Seguridad: Nadie puede aprobar un reembolso de hace 3 d√≠as.

Fluidez: Si el cliente se arrepiente, deja de hablar y vuelve al d√≠a siguiente preguntando "¬øTienen stock?", el bot no le dir√° "¬°Espera! A√∫n no aprob√© el reembolso anterior". Simplemente olvidar√° lo anterior y responder√° sobre el stock.

# Tiempo m√°ximo de espera (ej: 5 minutos)
TIEMPO_EXPIRACION_MINUTOS = 5